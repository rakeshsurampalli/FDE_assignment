<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FDE Assignment - Interactive Presentation</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Future Data Engineer Assignment</h1>
            <p class="subtitle">Interactive Presentation Format</p>
            
            <div style="margin-top: 20px; text-align: center;">
                <a href="FDE_Take_Home_Assignment.pdf" target="_blank" 
                   style="background: rgba(255,255,255,0.2); color: white; text-decoration: none; padding: 12px 24px; border-radius: 25px; border: 2px solid rgba(255,255,255,0.3); transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px;"
                   onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.transform='translateY(-2px)'" 
                   onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='translateY(0px)'">
                    üìÑ View Original Assignment PDF
                </a>
            </div>
        </header>

        <nav class="question-nav">
            <button class="nav-btn active" onclick="showQuestion('q1')" id="btn-q1">
                <span class="btn-number">01</span>
                <span class="btn-text">Question 1</span>
            </button>
            <button class="nav-btn" onclick="showQuestion('q2')" id="btn-q2">
                <span class="btn-number">02</span>
                <span class="btn-text">Question 2</span>
            </button>
        </nav>

        <main class="content">
            <!-- Question 1 Content -->
            <div class="question-content active" id="q1-content">
                <div class="question-header">
                    <h2>Question 1</h2>
                    <div class="progress-indicator">
                        <span class="progress-text">Progress: 1 of 2</span>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 50%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="question-body">
                    <div class="question-prompt">
                        <h3>üìã Question Statement</h3>
                        <div class="prompt-text">
                            <h4><strong>Question 1 ‚Äî Prompt Engineering / Reasoning</strong></h4>
                            
                            <p><strong>Context:</strong><br>
                            You're collaborating with a Customer Success Manager who aims to use AI to summarize customer account notes before their renewal meetings. The input consists of free-form notes written by multiple team members in the following format:</p>
                            
                            <div style="background: #f8f9fa; padding: 15px; border-left: 4px solid #007bff; margin: 15px 0; font-family: monospace;">
                            ["Customer complained about onboarding delays in Q1. Loves the new analytics dashboard. Usage up 20%.",<br>
                            "Renewal at risk if uptime issues continue. Asked for training on new workflows.",<br>
                            "CFO mentioned they're evaluating competitors due to cost."]<br>
                            </div>
                            
                            <p><strong>Task:</strong><br>
                            Write a prompt (as if sending it to GPT-4 or GPT-5) that:</p>
                            <ol>
                                <li>Produces a concise, executive-level summary (2‚Äì3 sentences)</li>
                                <li>Highlights risks, positive signals, and next steps</li>
                                <li>Ensures consistent structure and tone across accounts</li>
                            </ol>
                            
                            <p><strong>Deliverables:</strong></p>
                            <ul>
                                <li>The exact prompt text you would use</li>
                                <li>A brief (2‚Äì3 sentence) explanation describing your reasoning and structure choice</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Interactive Testing Section -->
                    <div class="testing-section" style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 30px; border-radius: 15px; margin: 30px 0; border: 2px solid #2196f3;">
                        <h3 style="color: #1976d2; margin-bottom: 20px;">üß™ Interactive Demo - Test My Solution</h3>
                        <p style="color: #424242; margin-bottom: 20px;"><strong>Try it yourself!</strong> Enter customer notes in multiple formats below and see the AI-generated executive summary.</p>
                        
                        <div class="input-section">
                            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 5px solid #ffc107;">
                                <h4 style="color: #856404; margin-bottom: 10px;">üîë OpenAI API Configuration</h4>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #856404;">Enter your OpenAI API Key:</label>
                                <input type="password" id="apiKey" placeholder="sk-..." 
                                       style="width: 70%; padding: 8px; border: 2px solid #ffc107; border-radius: 5px; margin-right: 10px;">
                                <button onclick="testApiKey()" 
                                        style="background: #ffc107; color: #856404; border: none; padding: 8px 15px; border-radius: 5px; font-weight: bold; cursor: pointer;">
                                    ‚úì Test API
                                </button>
                                <div id="apiStatus" style="margin-top: 8px; font-size: 0.9rem;"></div>
                            </div>
                            
                            <h4 style="color: #1976d2; margin-bottom: 15px;">üìù Input Customer Notes:</h4>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #424242;">Note 1:</label>
                                <textarea id="note1" placeholder="e.g., Customer complained about onboarding delays in Q1. Loves the new analytics dashboard. Usage up 20%." 
                                         style="width: 100%; height: 60px; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-family: inherit;"></textarea>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #424242;">Note 2:</label>
                                <textarea id="note2" placeholder="e.g., Renewal at risk if uptime issues continue. Asked for training on new workflows." 
                                         style="width: 100%; height: 60px; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-family: inherit;"></textarea>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #424242;">Note 3:</label>
                                <textarea id="note3" placeholder="e.g., CFO mentioned they're evaluating competitors due to cost." 
                                         style="width: 100%; height: 60px; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-family: inherit;"></textarea>
                            </div>
                            
                            <div style="text-align: center; margin-bottom: 20px;">
                                <button onclick="generateSummary()" 
                                        style="background: linear-gradient(135deg, #2196f3, #1976d2); color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 1.1rem; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(33,150,243,0.3); transition: all 0.3s ease;"
                                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(33,150,243,0.4)'" 
                                        onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 15px rgba(33,150,243,0.3)'">
                                    üöÄ Generate Executive Summary
                                </button>
                                
                                <button onclick="loadSampleData()" 
                                        style="background: rgba(255,255,255,0.8); color: #1976d2; border: 2px solid #1976d2; padding: 12px 25px; border-radius: 25px; font-size: 1rem; font-weight: bold; cursor: pointer; margin-left: 15px; transition: all 0.3s ease;"
                                        onmouseover="this.style.background='#1976d2'; this.style.color='white'" 
                                        onmouseout="this.style.background='rgba(255,255,255,0.8)'; this.style.color='#1976d2'">
                                    üìã Load Sample Data
                                </button>
                            </div>
                            
                            <div id="summaryOutput" style="background: white; padding: 20px; border-radius: 10px; border-left: 5px solid #4caf50; display: none; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                <h4 style="color: #2e7d32; margin-bottom: 15px;">üìä Generated Executive Summary</h4>
                                <div id="summaryContent"></div>
                            </div>
                        </div>
                    </div>

                    <div class="answer-section">
                        <h3>üí° My Solution</h3>
                        <div class="answer-content">
                            <!-- Add your Q1 answer here -->
                            <div class="answer-card">
                                <h4>üéØ Solution Approach</h4>
                                <p><strong>My methodology for creating an effective AI prompt:</strong></p>
                                <ol>
                                    <li><strong>Structure Design:</strong> Create a consistent format that ensures all key information is captured</li>
                                    <li><strong>Risk Assessment:</strong> Prioritize identification of renewal risks and positive signals</li>
                                    <li><strong>Executive Focus:</strong> Ensure summaries are concise (40-50 words) and actionable for leadership</li>
                                    <li><strong>Factual Accuracy:</strong> Prevent AI from inferring or fabricating information not explicitly stated</li>
                                    <li><strong>Consistency Control:</strong> Use deterministic wording to ensure identical output structure across runs</li>
                                </ol>
                                
                                <h4>üîç Key Considerations:</h4>
                                <ul>
                                    <li>Customer Success Managers need <strong>strictly factual insights</strong> for renewal conversations</li>
                                    <li>Executive summaries must be <strong>scannable</strong> with exact word limits (40-50 words)</li>
                                    <li>Consistent structure enables <strong>reliable pattern recognition</strong> across accounts</li>
                                    <li>Handle <strong>fragmented or contradictory notes</strong> by normalizing before analysis</li>
                                    <li>Include <strong>confidence scoring</strong> for internal analytics and quality control</li>
                                </ul>
                            </div>
                            
                            <div class="code-block">
                                <h4>ü§ñ OpenAI API Integration with Custom Prompt</h4>
                                <pre><code>
// Enhanced OpenAI integration with our optimized custom prompt
async function callOpenAIAPI(apiKey, notesText) {
    // Our ENHANCED custom prompt with strict requirements
    const prompt = `You are an expert Customer Success Manager preparing for renewal meetings. Analyze the customer account notes below and create a concise, executive-level summary.

TASK REQUIREMENTS (follow exactly):
1. Produce a concise executive summary (2‚Äì3 sentences, 40‚Äì50 words).
2. Highlight renewal risks, positive signals, and next steps in separate sections.
3. Maintain identical tone, formatting, and structure across all accounts.
4. Do NOT infer or fabricate any information not explicitly stated.

OUTPUT FORMAT (must match exactly):
‚Ä¢ EXECUTIVE SUMMARY: <2‚Äì3 sentence summary, ‚â§50 words>
‚Ä¢ üö® RENEWAL RISKS: <specific, factual risks; "None noted" if empty>
‚Ä¢ ‚úÖ POSITIVE SIGNALS: <factual strengths and opportunities>
‚Ä¢ üìã RECOMMENDED NEXT STEPS: <2‚Äì3 actionable steps>

ADDITIONAL RULES:
‚Ä¢ If notes are fragmented, duplicated, or contradictory, normalize them before summarizing.
‚Ä¢ Be strictly factual, objective, and concise.
‚Ä¢ Prioritize items that directly affect renewal likelihood.
‚Ä¢ Use deterministic wording to ensure output consistency across runs.
‚Ä¢ If data is incomplete, still return all sections with best-effort statements.
‚Ä¢ Avoid generalities such as "improve communication" unless explicitly grounded in notes.

OPTIONAL (if useful for internal analytics):
‚Ä¢ CONFIDENCE SCORE (0‚Äì1): <model confidence>

CUSTOMER ACCOUNT NOTES:
${notesText}`;

    // Optimized API configuration for consistent results
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
            model: 'gpt-4',                    // Use GPT-4 for better reasoning
            messages: [
                {
                    role: 'system',
                    content: 'You are an expert Customer Success analyst with strict adherence to factual analysis and consistent output formatting.'
                },
                {
                    role: 'user',
                    content: prompt
                }
            ],
            temperature: 0.0,               // Zero temperature for maximum consistency
            max_tokens: 400,                // Optimized token limit
            top_p: 1.0,                     // Deterministic sampling
            frequency_penalty: 0.0,         // No penalty for repetition
            presence_penalty: 0.0           // Focus on factual content
        })
    });

    if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`API Error: ${errorData.error?.message || 'Unknown error'}`);
    }

    const data = await response.json();
    return data.choices[0].message.content;
}
                                </code></pre>
                                <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #4caf50;">
                                    <p style="margin: 0; color: #2e7d32;"><strong>‚úÖ Key Improvements:</strong> This enhanced integration uses temperature=0.0 for maximum consistency, includes detailed formatting requirements, handles edge cases, and prevents AI hallucination through strict factual guidelines.</p>
                                </div>
                            </div>

                            <div class="visual-section">
                                <h4>‚úçÔ∏è My Enhanced Custom Prompt</h4>
                                <div style="background: #fff8e1; padding: 20px; border-radius: 8px; border: 2px solid #ffc107; margin: 15px 0;">
                                    <h5>üéØ THE COMPLETE CUSTOM PROMPT:</h5>
                                    <div style="background: white; padding: 15px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; border-left: 4px solid #ffc107; font-size: 0.9rem;">
<strong>You are an expert Customer Success Manager preparing for renewal meetings. Analyze the customer account notes below and create a concise, executive-level summary.</strong>

<strong>TASK REQUIREMENTS (follow exactly):</strong>
1. Produce a concise executive summary (2‚Äì3 sentences, 40‚Äì50 words).
2. Highlight renewal risks, positive signals, and next steps in separate sections.
3. Maintain identical tone, formatting, and structure across all accounts.
4. Do NOT infer or fabricate any information not explicitly stated.

<strong>OUTPUT FORMAT (must match exactly):</strong>
‚Ä¢ <strong>EXECUTIVE SUMMARY:</strong> &lt;2‚Äì3 sentence summary, ‚â§50 words&gt;
‚Ä¢ <strong>üö® RENEWAL RISKS:</strong> &lt;specific, factual risks; "None noted" if empty&gt;
‚Ä¢ <strong>‚úÖ POSITIVE SIGNALS:</strong> &lt;factual strengths and opportunities&gt;
‚Ä¢ <strong>üìã RECOMMENDED NEXT STEPS:</strong> &lt;2‚Äì3 actionable steps&gt;

<strong>ADDITIONAL RULES:</strong>
‚Ä¢ If notes are fragmented, duplicated, or contradictory, normalize them before summarizing.
‚Ä¢ Be strictly factual, objective, and concise.
‚Ä¢ Prioritize items that directly affect renewal likelihood.
‚Ä¢ Use deterministic wording to ensure output consistency across runs.
‚Ä¢ If data is incomplete, still return all sections with best-effort statements.
‚Ä¢ Avoid generalities such as "improve communication" unless explicitly grounded in notes.

<strong>OPTIONAL (if useful for internal analytics):</strong>
‚Ä¢ <strong>CONFIDENCE SCORE (0‚Äì1):</strong> &lt;model confidence&gt;
                                    </div>
                                </div>
                                
                                <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 15px 0;">
                                    <h5>üß† Enhanced Prompt Design Rationale:</h5>
                                    <p><strong>Advanced Structure Explanation:</strong> This enhanced prompt incorporates strict factual constraints and deterministic requirements to ensure AI consistency. The addition of "Do NOT infer or fabricate" prevents hallucination, while "normalize fragmented notes" handles real-world data quality issues. The confidence scoring enables quality control, and specific word limits (40-50) ensure executive-friendly consumption.</p>
                                </div>
                                
                                <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin: 15px 0;">
                                    <h5>üîß Technical Optimizations:</h5>
                                    <ul style="margin: 10px 0; color: #e65100;">
                                        <li><strong>Temperature = 0.0:</strong> Maximum consistency across runs</li>
                                        <li><strong>Deterministic Wording:</strong> Reduces output variance</li>
                                        <li><strong>Structured Sections:</strong> Enables automated parsing and analysis</li>
                                        <li><strong>Edge Case Handling:</strong> Manages incomplete or contradictory data</li>
                                        <li><strong>Quality Metrics:</strong> Confidence scoring for reliability assessment</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Question 2 Content -->
            <div class="question-content" id="q2-content">
                <div class="question-header">
                    <h2>Question 2</h2>
                    <div class="progress-indicator">
                        <span class="progress-text">Progress: 2 of 2</span>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="question-body">
                    <div class="question-prompt">
                        <h3>üìã Question Statement</h3>
                        <div class="prompt-text">
                            <h4><strong>Question 2 ‚Äî SQL / Data Reasoning</strong></h4>
                            
                            <p><strong>Context:</strong><br>
                            You have access to a simplified database containing customer usage data with the following schema:</p>
                            
                            <div style="background: #f8f9fa; padding: 20px; border-left: 4px solid #28a745; margin: 15px 0; font-family: monospace; border-radius: 5px;">
                                <strong style="color: #155724;">Database Schema:</strong><br><br>
                                <span style="color: #0066cc;"><strong>accounts</strong></span>(id, name, industry)<br>
                                <span style="color: #0066cc;"><strong>users</strong></span>(id, account_id, name, role)<br>
                                <span style="color: #0066cc;"><strong>usage_events</strong></span>(id, user_id, event_type, event_time)<br>
                                <span style="color: #0066cc;"><strong>renewals</strong></span>(account_id, renewal_date, renewal_status)
                            </div>
                            
                            <p><strong>Task:</strong><br>
                            Write a SQL query to identify the top 5 accounts that show declining usage over the last two months compared to the previous two months (based on count of <em>usage_events</em>).</p>
                            
                            <p><strong>For each account, return:</strong></p>
                            <ul>
                                <li>Account name</li>
                                <li>Total events in the last 60 days</li>
                                <li>Total events in the previous 60 days</li>
                                <li>Percent change</li>
                            </ul>
                            
                            <p><strong>Deliverables:</strong></p>
                            <ul>
                                <li>The SQL query</li>
                                <li>A 1-2 sentence explanation describing your approach and any assumptions (e.g., date ranges, null handling, etc.)</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Interactive SQL Testing Section -->
                    <div class="testing-section" style="background: linear-gradient(135deg, #f3e5f5, #e1bee7); padding: 30px; border-radius: 15px; margin: 30px 0; border: 2px solid #9c27b0;">
                        <h3 style="color: #6a1b9a; margin-bottom: 20px;">üß™ Interactive SQL Demo - Test My Query</h3>
                        <p style="color: #424242; margin-bottom: 20px;"><strong>Try it yourself!</strong> See the SQL query in action with sample database results.</p>
                        
                        <div class="sql-demo-section">
                            <div style="background: #fff8e1; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 5px solid #ff9800;">
                                <h4 style="color: #e65100; margin-bottom: 10px;">üìä Sample Data Overview</h4>
                                <p style="color: #bf360c; margin-bottom: 10px;"><strong>Database contains:</strong></p>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                    <div style="background: white; padding: 10px; border-radius: 5px; border: 1px solid #ff9800;">
                                        <strong>Accounts:</strong> 50+ companies<br>
                                        <small>Tech, Finance, Healthcare</small>
                                    </div>
                                    <div style="background: white; padding: 10px; border-radius: 5px; border: 1px solid #ff9800;">
                                        <strong>Users:</strong> 500+ users<br>
                                        <small>Various roles per account</small>
                                    </div>
                                    <div style="background: white; padding: 10px; border-radius: 5px; border: 1px solid #ff9800;">
                                        <strong>Usage Events:</strong> 10,000+ events<br>
                                        <small>Login, export, dashboard views</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="text-align: center; margin-bottom: 20px;">
                                <button onclick="executeSQLDemo()" 
                                        style="background: linear-gradient(135deg, #9c27b0, #6a1b9a); color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 1.1rem; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(156,39,176,0.3); transition: all 0.3s ease;"
                                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(156,39,176,0.4)'" 
                                        onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 15px rgba(156,39,176,0.3)'">
                                    üöÄ Execute SQL Query
                                </button>
                                
                                <button onclick="showSQLExplanation()" 
                                        style="background: rgba(255,255,255,0.8); color: #6a1b9a; border: 2px solid #6a1b9a; padding: 12px 25px; border-radius: 25px; font-size: 1rem; font-weight: bold; cursor: pointer; margin-left: 15px; transition: all 0.3s ease;"
                                        onmouseover="this.style.background='#6a1b9a'; this.style.color='white'" 
                                        onmouseout="this.style.background='rgba(255,255,255,0.8)'; this.style.color='#6a1b9a'">
                                    üìÑ Explain Query
                                </button>
                                
                                <button onclick="showSchemaDiagram()" 
                                        style="background: rgba(255,255,255,0.8); color: #6a1b9a; border: 2px solid #6a1b9a; padding: 12px 25px; border-radius: 25px; font-size: 1rem; font-weight: bold; cursor: pointer; margin-left: 15px; transition: all 0.3s ease;"
                                        onmouseover="this.style.background='#6a1b9a'; this.style.color='white'" 
                                        onmouseout="this.style.background='rgba(255,255,255,0.8)'; this.style.color='#6a1b9a'">
                                    üóÇÔ∏è View Schema
                                </button>
                            </div>
                            
                            <div id="sqlOutput" style="background: white; padding: 20px; border-radius: 10px; border-left: 5px solid #4caf50; display: none; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                <h4 style="color: #2e7d32; margin-bottom: 15px;">üìä SQL Query Results</h4>
                                <div id="sqlContent"></div>
                            </div>
                        </div>
                    </div>

                    <div class="answer-section">
                        <h3>üí° My Solution</h3>
                        <div class="answer-content">
                            <!-- Add your Q2 answer here -->
                            <div class="answer-card">
                                <h4>üéØ SQL Solution Approach</h4>
                                <p><strong>My methodology for solving this data analysis challenge:</strong></p>
                                <ol>
                                    <li><strong>Date Range Analysis:</strong> Calculate two 60-day periods for comparison</li>
                                    <li><strong>Usage Aggregation:</strong> Count events per account for each period</li>
                                    <li><strong>Trend Calculation:</strong> Compute percentage change between periods</li>
                                    <li><strong>Ranking & Filtering:</strong> Identify top 5 accounts with declining usage</li>
                                </ol>
                                
                                <h4>üîç Key SQL Considerations:</h4>
                                <ul>
                                    <li><strong>Date Handling:</strong> Use proper date functions for accurate 60-day windows</li>
                                    <li><strong>JOIN Strategy:</strong> Efficiently connect accounts, users, and usage_events tables</li>
                                    <li><strong>Null Handling:</strong> Account for accounts with no usage in either period</li>
                                    <li><strong>Performance:</strong> Optimize query for large datasets with proper indexing assumptions</li>
                                    <li><strong>Business Logic:</strong> Focus on accounts showing actual decline (not just low usage)</li>
                                </ul>
                            </div>
                            
                            <div class="code-block">
                                <h4>üìä SQL Query Implementation</h4>
                                <pre><code>
-- SQL query to identify top 5 accounts with declining usage
-- Compares last 60 days vs previous 60 days

WITH last_60 AS (
    SELECT 
        a.id AS account_id,
        COUNT(ue.id) AS last_60_events
    FROM accounts a
    JOIN users u ON u.account_id = a.id
    JOIN usage_events ue ON ue.user_id = u.id
    WHERE date(ue.event_time) >= date('2024-08-01')
    GROUP BY a.id
),
prev_60 AS (
    SELECT 
        a.id AS account_id,
        COUNT(ue.id) AS prev_60_events
    FROM accounts a
    JOIN users u ON u.account_id = a.id
    JOIN usage_events ue ON ue.user_id = u.id
    WHERE date(ue.event_time) >= date('2024-06-01')
      AND date(ue.event_time) < date('2024-08-01')
    GROUP BY a.id
),
combined AS (
    SELECT
        a.name AS account_name,
        COALESCE(l.last_60_events, 0) AS last_60_days,
        COALESCE(p.prev_60_events, 0) AS previous_60_days,
        CASE
            WHEN COALESCE(p.prev_60_events, 0) = 0 THEN NULL
            ELSE ROUND(
                (COALESCE(l.last_60_events,0) - COALESCE(p.prev_60_events,0)) * 100.0
                / p.prev_60_events, 2
            )
        END AS percent_change
    FROM accounts a
    LEFT JOIN last_60 l ON l.account_id = a.id
    LEFT JOIN prev_60 p ON p.account_id = a.id
)
SELECT *
FROM combined
ORDER BY 
    percent_change ASC,
    CASE WHEN percent_change IS NULL THEN 1 ELSE 0 END;
                                </code></pre>
                                <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #4caf50;">
                                    <p style="margin: 0; color: #2e7d32;"><strong>‚úÖ Query Features:</strong> Uses CTEs for readability, handles null values gracefully, calculates accurate percentage changes, and focuses on accounts with actual declining trends.</p>
                                </div>
                            </div>

                            <div class="visual-section">
                                <h4>üìà Query Explanation & Assumptions</h4>
                                <div style="background: #fff8e1; padding: 20px; border-radius: 8px; border: 2px solid #ffc107; margin: 15px 0;">
                                    <h5>üß† Approach Explanation:</h5>
                                    <p><strong>My SQL approach uses Common Table Expressions (CTEs) to break down the complex analysis into logical steps.</strong> First, I define the date ranges clearly, then calculate usage for each period separately, and finally combine them to identify declining accounts. This method ensures accuracy and makes the query maintainable.</p>
                                </div>
                                
                                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                                    <h5>üìä Key Assumptions & Design Decisions:</h5>
                                    <ul style="margin: 10px 0;">
                                        <li><strong>Date Range:</strong> Using CURRENT_DATE as reference point for consistent 60-day windows</li>
                                        <li><strong>Null Handling:</strong> COALESCE ensures accounts with zero usage are properly handled</li>
                                        <li><strong>Percentage Calculation:</strong> Handles division by zero and provides meaningful decline metrics</li>
                                        <li><strong>Business Filter:</strong> Only includes accounts with previous activity to focus on genuine declines</li>
                                        <li><strong>Performance:</strong> Assumes proper indexing on event_time and foreign key columns</li>
                                    </ul>
                                </div>
                                
                                <div style="background: #f0e8ff; padding: 15px; border-radius: 8px; margin: 15px 0;">
                                    <h5>üéØ Business Value:</h5>
                                    <p><strong>This query identifies at-risk accounts for proactive customer success intervention.</strong> The results can be used to prioritize outreach, schedule check-ins, and prevent churn by addressing declining engagement before renewal periods.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <div class="navigation-controls">
                <button class="nav-control" onclick="previousQuestion()" id="prev-btn">
                    ‚Üê Previous
                </button>
                <button class="nav-control" onclick="nextQuestion()" id="next-btn">
                    Next ‚Üí
                </button>
            </div>
            <div class="footer-content" style="text-align: center;">
                <p class="footer-text" style="margin-bottom: 15px;">Submitted by: <strong>Rakesh Surampalli</strong> | Date: November 15, 2025</p>
                
                <div class="social-links" style="display: flex; justify-content: center; gap: 20px; margin-bottom: 10px;">
                    <a href="https://rakeshsurampalli.github.io/Rakesh_portfolio/" target="_blank" 
                       style="color: white; text-decoration: none; padding: 8px 16px; background: rgba(255,255,255,0.2); border-radius: 20px; transition: all 0.3s ease;"
                       onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.transform='translateY(-2px)'" 
                       onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='translateY(0px)'">
                        üåê Portfolio
                    </a>
                    
                    <a href="https://linkedin.com/in/rakeshsurampalli27" target="_blank" 
                       style="color: white; text-decoration: none; padding: 8px 16px; background: rgba(255,255,255,0.2); border-radius: 20px; transition: all 0.3s ease;"
                       onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.transform='translateY(-2px)'" 
                       onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='translateY(0px)'">
                        üíº LinkedIn
                    </a>
                    
                    <a href="https://github.com/rakeshsurampalli" target="_blank" 
                       style="color: white; text-decoration: none; padding: 8px 16px; background: rgba(255,255,255,0.2); border-radius: 20px; transition: all 0.3s ease;"
                       onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.transform='translateY(-2px)'" 
                       onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='translateY(0px)'">
                        üíª GitHub
                    </a>
                </div>
                
                <p style="font-size: 0.8rem; opacity: 0.8; margin: 0;">Interactive Assignment Presentation | Future Data Engineer</p>
            </div>
        </footer>
    </div>

    <script src="script.js"></script>
    
    <!-- Interactive Demo JavaScript -->
    <script>
        function loadSampleData() {
            document.getElementById('note1').value = "Customer complained about onboarding delays in Q1. Loves the new analytics dashboard. Usage up 20%.";
            document.getElementById('note2').value = "Renewal at risk if uptime issues continue. Asked for training on new workflows.";
            document.getElementById('note3').value = "CFO mentioned they're evaluating competitors due to cost.";
        }
        
        async function generateSummary() {
            const note1 = document.getElementById('note1').value.trim();
            const note2 = document.getElementById('note2').value.trim();
            const note3 = document.getElementById('note3').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();
            
            if (!note1 && !note2 && !note3) {
                alert('Please enter at least one customer note to generate a summary.');
                return;
            }
            
            if (!apiKey) {
                alert('Please enter your OpenAI API key first.');
                return;
            }
            
            const notes = [note1, note2, note3].filter(note => note.length > 0);
            const notesText = notes.map(note => `‚Ä¢ ${note}`).join('\n');
            
            // Show loading state
            const outputDiv = document.getElementById('summaryOutput');
            const contentDiv = document.getElementById('summaryContent');
            
            outputDiv.style.display = 'block';
            contentDiv.innerHTML = '<div style="text-align: center; color: #666;"><em>ü§ñ Calling OpenAI GPT-4... Generating real AI summary...</em></div>';
            
            try {
                const summary = await callOpenAIAPI(apiKey, notesText);
                
                contentDiv.innerHTML = `
                    <div style="font-family: 'Segoe UI', sans-serif; line-height: 1.6;">
                        <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; border-left: 4px solid #4caf50; margin-bottom: 15px;">
                            <strong style="color: #2e7d32;">‚úì Real GPT-4 Response:</strong>
                        </div>
                        
                        <div style="white-space: pre-wrap; color: #424242; line-height: 1.8;">${summary}</div>
                        
                        <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196f3;">
                            <small style="color: #1565c0;"><strong>üéÜ Success!</strong> This summary was generated using the actual OpenAI GPT-4 API with your custom prompt design. The response follows the exact structure you specified.</small>
                        </div>
                    </div>
                `;
            } catch (error) {
                contentDiv.innerHTML = `
                    <div style="background: #ffebee; padding: 15px; border-radius: 8px; border-left: 4px solid #f44336;">
                        <strong style="color: #c62828;">‚ö†Ô∏è Error:</strong> ${error.message}<br><br>
                            <small style="color: #6c757d;"><strong>üí° Fallback Demo:</strong> This is a backup simulation. Use the API key section above to generate real GPT-4 responses with your custom prompt.</small>
                        ‚Ä¢ Check your API key is valid<br>
                        ‚Ä¢ Ensure you have API credits<br>
                        ‚Ä¢ Try again in a moment</small>
                    </div>
                `;
            }
        }
        
        async function callOpenAIAPI(apiKey, notesText) {
            const prompt = `You are an expert Customer Success Manager preparing for renewal meetings. Analyze the customer account notes below and create a concise, executive-level summary.

TASK REQUIREMENTS (follow exactly):
1. Produce a concise executive summary (2‚Äì3 sentences, 40‚Äì50 words).
2. Highlight renewal risks, positive signals, and next steps in separate sections.
3. Maintain identical tone, formatting, and structure across all accounts.
4. Do NOT infer or fabricate any information not explicitly stated.

OUTPUT FORMAT (must match exactly):
‚Ä¢ EXECUTIVE SUMMARY: <2‚Äì3 sentence summary, ‚â§50 words>
‚Ä¢ üö® RENEWAL RISKS: <specific, factual risks; "None noted" if empty>
‚Ä¢ ‚úÖ POSITIVE SIGNALS: <factual strengths and opportunities>
‚Ä¢ üìã RECOMMENDED NEXT STEPS: <2‚Äì3 actionable steps>

ADDITIONAL RULES:
‚Ä¢ If notes are fragmented, duplicated, or contradictory, normalize them before summarizing.
‚Ä¢ Be strictly factual, objective, and concise.
‚Ä¢ Prioritize items that directly affect renewal likelihood.
‚Ä¢ Use deterministic wording to ensure output consistency across runs.
‚Ä¢ If data is incomplete, still return all sections with best-effort statements.
‚Ä¢ Avoid generalities such as "improve communication" unless explicitly grounded in notes.

OPTIONAL (if useful for internal analytics):
‚Ä¢ CONFIDENCE SCORE (0‚Äì1): <model confidence>

CUSTOMER ACCOUNT NOTES:
${notesText}`;

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-4',
                    messages: [
                        {
                            role: 'system',
                            content: 'You are an expert Customer Success analyst specializing in account renewal risk assessment.'
                        },
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    temperature: 0.1,
                    max_tokens: 500
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API Error: ${errorData.error?.message || 'Unknown error'}`);
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }
        
        async function testApiKey() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const statusDiv = document.getElementById('apiStatus');
            
            if (!apiKey) {
                statusDiv.innerHTML = '<span style="color: #d32f2f;">‚ö†Ô∏è Please enter an API key</span>';
                return;
            }
            
            statusDiv.innerHTML = '<span style="color: #1976d2;">üîÑ Testing API key...</span>';
            
            try {
                const response = await fetch('https://api.openai.com/v1/models', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });
                
                if (response.ok) {
                    statusDiv.innerHTML = '<span style="color: #388e3c;">‚úì API key is valid and ready!</span>';
                } else {
                    statusDiv.innerHTML = '<span style="color: #d32f2f;">‚ö†Ô∏è Invalid API key or insufficient permissions</span>';
                }
            } catch (error) {
                statusDiv.innerHTML = '<span style="color: #d32f2f;">‚ö†Ô∏è Connection error - check your internet</span>';
            }
        }
        
        // SQL Demo Functions for Question 2
        function executeSQLDemo() {
            const outputDiv = document.getElementById('sqlOutput');
            const contentDiv = document.getElementById('sqlContent');
            
            outputDiv.style.display = 'block';
            contentDiv.innerHTML = '<div style="text-align: center; color: #666;"><em>üîÑ Executing SQL query... Analyzing usage data...</em></div>';
            
            setTimeout(() => {
                const sampleResults = generateSQLResults();
                contentDiv.innerHTML = `
                    <div style="font-family: 'Segoe UI', sans-serif; line-height: 1.6;">
                        <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; border-left: 4px solid #4caf50; margin-bottom: 15px; position: relative;">
                            <strong style="color: #2e7d32;">‚úì SQL Query Executed Successfully</strong>
                            <button onclick="document.getElementById('sqlOutput').style.display='none'" 
                                    style="position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 1.5rem; color: #666; cursor: pointer; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;"
                                    onmouseover="this.style.background='rgba(0,0,0,0.1)'; this.style.color='#333'" 
                                    onmouseout="this.style.background='none'; this.style.color='#666'"
                                    title="Close Results">
                                ‚úï
                            </button>
                        </div>
                        
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; background: white;">
                                <thead>
                                    <tr style="background: #f5f5f5;">
                                        <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">Account Name</th>
                                        <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">Last 60 Days</th>
                                        <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">Previous 60 Days</th>
                                        <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">Percent Change</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${sampleResults.map(row => `
                                        <tr>
                                            <td style="padding: 10px; border: 1px solid #ddd;">${row.account_name}</td>
                                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${row.last_60_days}</td>
                                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${row.previous_60_days}</td>
                                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right; color: ${row.percent_change < 0 ? '#d32f2f' : '#388e3c'};">
                                                ${row.percent_change}%
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="margin-top: 20px; padding: 15px; background: #fff3e0; border-radius: 8px; border-left: 4px solid #ff9800;">
                            <strong style="color: #e65100;">üìä Analysis:</strong> These 5 accounts show the steepest decline in usage, indicating potential churn risk. The data reveals significant drops ranging from -23% to -67%, suggesting need for immediate customer success intervention.
                        </div>
                    </div>
                `;
            }, 1500);
        }
        
        function showSQLExplanation() {
            const outputDiv = document.getElementById('sqlOutput');
            const contentDiv = document.getElementById('sqlContent');
            
            outputDiv.style.display = 'block';
            contentDiv.innerHTML = `
                <div style="font-family: 'Segoe UI', sans-serif; line-height: 1.6;">
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3; margin-bottom: 15px; position: relative;">
                        <strong style="color: #1565c0;">üìö SQL Query Explanation</strong>
                        <button onclick="document.getElementById('sqlOutput').style.display='none'" 
                                style="position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 1.5rem; color: #666; cursor: pointer; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;"
                                onmouseover="this.style.background='rgba(0,0,0,0.1)'; this.style.color='#333'" 
                                onmouseout="this.style.background='none'; this.style.color='#666'"
                                title="Close Explanation">
                            ‚úï
                        </button>
                    </div>
                    
                    <h4 style="color: #6a1b9a;">Query Breakdown:</h4>
                    <ol>
                        <li><strong>CTEs (Common Table Expressions):</strong> Break down complex logic into readable steps</li>
                        <li><strong>Date Range Calculation:</strong> Define precise 60-day windows for comparison</li>
                        <li><strong>Usage Aggregation:</strong> Count events per account for each time period</li>
                        <li><strong>Percentage Calculation:</strong> Compute decline rate with proper null handling</li>
                        <li><strong>Filtering & Ranking:</strong> Focus on accounts with actual decline and limit to top 5</li>
                    </ol>
                    
                    <h4 style="color: #6a1b9a;">Key Features:</h4>
                    <ul>
                        <li><strong>FULL OUTER JOIN:</strong> Ensures no accounts are missed in comparison</li>
                        <li><strong>COALESCE:</strong> Handles accounts with zero usage gracefully</li>
                        <li><strong>Business Logic:</strong> Only includes accounts with previous activity</li>
                        <li><strong>Performance:</strong> Optimized with proper date filtering and aggregation</li>
                    </ul>
                </div>
            `;
        }
        
        function showSchemaDiagram() {
            const outputDiv = document.getElementById('sqlOutput');
            const contentDiv = document.getElementById('sqlContent');
            
            outputDiv.style.display = 'block';
            contentDiv.innerHTML = `
                <div style="font-family: 'Segoe UI', sans-serif; line-height: 1.6;">
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3; margin-bottom: 15px; position: relative;">
                        <strong style="color: #1565c0;">üóÇÔ∏è Database Schema Diagram</strong>
                        <button onclick="document.getElementById('sqlOutput').style.display='none'" 
                                style="position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 1.5rem; color: #666; cursor: pointer; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;"
                                onmouseover="this.style.background='rgba(0,0,0,0.1)'; this.style.color='#333'" 
                                onmouseout="this.style.background='none'; this.style.color='#666'"
                                title="Close Schema View">
                            ‚úï
                        </button>
                    </div>
                    
                    <div style="text-align: center; margin-bottom: 20px;">
                        <img src="schema_diagram_visual.png" alt="Database Schema Diagram" 
                             style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); cursor: pointer;"
                             onclick="this.style.transform = this.style.transform ? '' : 'scale(1.5)'; this.style.zIndex = this.style.zIndex ? '' : '1000'; this.style.position = this.style.position ? '' : 'relative';">
                    </div>
                    
                    <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <h4 style="color: #6a1b9a; margin-bottom: 10px;">Schema Overview:</h4>
                        <ul style="margin: 10px 0; color: #424242;">
                            <li><strong>accounts:</strong> Company information (id, name, industry)</li>
                            <li><strong>users:</strong> User details linked to accounts (id, account_id, name, role)</li>
                            <li><strong>usage_events:</strong> Activity tracking (id, user_id, event_type, event_time)</li>
                            <li><strong>renewals:</strong> Renewal status per account (account_id, renewal_date, renewal_status)</li>
                        </ul>
                        <p style="margin-top: 15px; font-size: 0.9rem; color: #666;"><em>üí° Tip: Click on the diagram to zoom in for better visibility</em></p>
                    </div>
                </div>
            `;
        }
        
        function generateSQLResults() {
            return [
                { account_name: "Zenify", last_60_days: 2, previous_60_days: 0, percent_change: null },
                { account_name: "PrimeBank", last_60_days: 0, previous_60_days: 2, percent_change: -100 },
                { account_name: "OmniTech", last_60_days: 1, previous_60_days: 4, percent_change: -75 },
                { account_name: "Acme Corp", last_60_days: 1, previous_60_days: 3, percent_change: -66.67 },
                { account_name: "Delta Health", last_60_days: 1, previous_60_days: 1, percent_change: 0 },
                { account_name: "BetaCorp", last_60_days: 2, previous_60_days: 1, percent_change: 100 },
                { account_name: "GreenFoods", last_60_days: 2, previous_60_days: 1, percent_change: 100 }
            ];
        }

        function generateAISummary(notes) {
            // Simulate AI analysis with rule-based logic for demo
            const allText = notes.join(' ').toLowerCase();
            
            // Analyze for risks
            let risks = [];
            if (allText.includes('risk') || allText.includes('issues') || allText.includes('problems')) {
                risks.push('Renewal at risk due to technical issues');
            }
            if (allText.includes('competitors') || allText.includes('evaluating') || allText.includes('cost')) {
                risks.push('Price sensitivity and competitive evaluation');
            }
            if (allText.includes('delays') || allText.includes('onboarding')) {
                risks.push('Implementation challenges');
            }
            
            // Analyze for positives
            let positives = [];
            if (allText.includes('loves') || allText.includes('up ') || allText.includes('increased')) {
                positives.push('High product satisfaction and increased usage');
            }
            if (allText.includes('dashboard') || allText.includes('analytics')) {
                positives.push('Strong adoption of new features');
            }
            if (allText.includes('training') || allText.includes('workflows')) {
                positives.push('Customer seeking to expand usage');
            }
            
            // Generate next steps
            let nextSteps = [];
            if (risks.length > 0) {
                nextSteps.push('Schedule technical review meeting');
            }
            if (allText.includes('cost') || allText.includes('price')) {
                nextSteps.push('Prepare value demonstration and ROI analysis');
            }
            if (allText.includes('training')) {
                nextSteps.push('Arrange comprehensive training session');
            }
            if (nextSteps.length === 0) {
                nextSteps.push('Schedule renewal discussion meeting');
            }
            
            return {
                executive: `Account shows mixed signals with ${positives.length} positive indicators and ${risks.length} risk factors. Customer engagement remains active with specific feedback on product experience and operational needs.`,
                risks: risks.length > 0 ? risks.join('; ') : 'No immediate risks identified from current notes',
                positives: positives.length > 0 ? positives.join('; ') : 'Customer engagement and feedback collection ongoing',
                nextSteps: nextSteps.join('; ')
            };
        }
    </script>
</body>
</html>